<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF æ¸¬è©¦ä»»å‹™ä¸­å¿ƒ - è¶…ç´šé™¤éŒ¯ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/sdk/2.23.0/liff.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 400px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-box { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-top: 15px; 
            border-radius: 8px; 
            background-color: #fafafa;
        }
        h1 { 
            color: #00B900; 
            text-align: center;
            margin-bottom: 10px;
        }
        button { 
            background-color: #00B900; 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            width: 100%;
            margin-top: 10px;
        }
        button:hover { 
            background-color: #009900; 
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status { 
            padding: 10px; 
            border-radius: 5px; 
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .status.loading { 
            background-color: #fff3cd; 
            color: #856404; 
        }
        .status.success { 
            background-color: #d4edda; 
            color: #155724; 
        }
        .status.error { 
            background-color: #f8d7da; 
            color: #721c24; 
        }
        .debug-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }
        .debug-log p {
            margin: 5px 0;
            padding: 3px;
            border-bottom: 1px solid #e9ecef;
            word-break: break-all;
        }
        .info-row {
            margin: 10px 0;
            padding: 8px;
            background-color: white;
            border-radius: 5px;
        }
        .info-label {
            color: #666;
            font-size: 14px;
        }
        .info-value {
            color: #333;
            font-weight: bold;
            font-size: 16px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Line ä»»å‹™ç³»çµ±</h1>
        <p style="text-align: center; color: #666; font-size: 14px;">è¶…ç´šé™¤éŒ¯ç‰ˆ v3.0</p>

        <div id="liff-status" class="status loading">æ­£åœ¨åˆå§‹åŒ– LIFF...</div>

        <div class="info-box">
            <h3 style="margin-top: 0;">ğŸ‘¤ æœƒå“¡è³‡è¨Š</h3>
            <div class="info-row">
                <div class="info-label">Line åç¨±</div>
                <div class="info-value" id="user-name">--</div>
            </div>
            <div class="info-row">
                <div class="info-label">User ID</div>
                <div class="info-value" id="user-id-display" style="font-size: 12px;">--</div>
            </div>
            <div class="info-row">
                <div class="info-label">ç•¶å‰é»æ•¸</div>
                <div class="info-value" id="current-points" style="color: #00B900; font-size: 24px;">0 é»</div>
            </div>
        </div>
        
        <div class="info-box" id="task-area" style="display:none;">
            <h3 style="margin-top: 0;">âœ… æ¯æ—¥ä»»å‹™</h3>
            <button id="sign-in-btn" onclick="signInTask()">
                ğŸ“ é»æ“Šç°½åˆ° (+10é»)
            </button>
            <p id="task-message" style="text-align: center; margin-top: 10px; color: #666;"></p>
        </div>

        <button id="liff-login" onclick="liffLogin()" style="display:none;">
            ğŸ” è«‹é»æ“Šç™»å…¥ Line
        </button>

        <div class="debug-log" id="debug-log">
            <strong>é™¤éŒ¯æ—¥èªŒï¼š</strong>
        </div>
    </div>
    
    <script>
        // ========== è¨­å®šå€ ==========
        const MY_LIFF_ID = '2008638301-NeqDPLxQ'; 
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSCWxqEMxkGRC-me5BIO-94u4IPpGWzPWp6OoBuZBpT3mOEu3GDz4vzQdX29BylXgq_Q/exec';

        let currentUserId = null;
        let initTimeout = null;

        // ========== é™¤éŒ¯å·¥å…· ==========
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : '#333';
            logDiv.innerHTML += `<p style="color: ${color}">[${timestamp}] ${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('liff-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // ========== LIFF åˆå§‹åŒ–ï¼ˆåŠ å¼·ç‰ˆï¼‰ ==========
        function initializeLiff() {
            addLog('ğŸš€ æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•');
            addLog(`ç•¶å‰ç¶²å€: ${window.location.href}`);
            addLog(`User Agent: ${navigator.userAgent.substring(0, 50)}...`);
            addLog('---');
            addLog('é–‹å§‹åˆå§‹åŒ– LIFF...');
            addLog(`LIFF ID: ${MY_LIFF_ID}`);
            
            // è¨­ç½® 10 ç§’è¶…æ™‚
            initTimeout = setTimeout(() => {
                addLog('âŒ LIFF åˆå§‹åŒ–è¶…æ™‚ (10ç§’)ï¼', 'error');
                updateStatus('åˆå§‹åŒ–è¶…æ™‚ï¼Œå¯èƒ½æ˜¯ç¶²è·¯å•é¡Œæˆ– LIFF è¨­å®šéŒ¯èª¤', 'error');
                addLog('è«‹æª¢æŸ¥ï¼š', 'error');
                addLog('1. LIFF ID æ˜¯å¦æ­£ç¢º', 'error');
                addLog('2. Endpoint URL æ˜¯å¦æ­£ç¢ºè¨­å®š', 'error');
                addLog('3. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸', 'error');
            }, 10000);

            liff.init({ 
                liffId: MY_LIFF_ID,
                withLoginOnExternalBrowser: true
            })
            .then(() => {
                clearTimeout(initTimeout);
                addLog('âœ… LIFF åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                updateStatus('LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è©³ç´°ç’°å¢ƒè³‡è¨Š
                addLog(`ç™»å…¥ç‹€æ…‹: ${liff.isLoggedIn() ? 'âœ… å·²ç™»å…¥' : 'âŒ æœªç™»å…¥'}`);
                addLog(`åŸ·è¡Œç’°å¢ƒ: ${liff.isInClient() ? 'LINE App å…§' : 'å¤–éƒ¨ç€è¦½å™¨'}`);
                addLog(`LIFF OS: ${liff.getOS()}`);
                addLog(`LIFF èªè¨€: ${liff.getLanguage()}`);
                addLog(`LIFF ç‰ˆæœ¬: ${liff.getVersion()}`);
                addLog(`æ˜¯å¦ç‚º API å¯ç”¨: ${liff.isApiAvailable('shareTargetPicker')}`);
                
                if (liff.isLoggedIn()) {
                    addLog('---');
                    getUserProfile();
                } else {
                    updateStatus('å°šæœªç™»å…¥ Line', 'error');
                    document.getElementById('liff-login').style.display = 'block';
                    addLog('ğŸ”“ é¡¯ç¤ºç™»å…¥æŒ‰éˆ•');
                }
            })
            .catch((err) => {
                clearTimeout(initTimeout);
                addLog(`âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼`, 'error');
                addLog(`éŒ¯èª¤é¡å‹: ${err.name}`, 'error');
                addLog(`éŒ¯èª¤è¨Šæ¯: ${err.message}`, 'error');
                addLog(`éŒ¯èª¤å †ç–Š: ${err.stack}`, 'error');
                updateStatus(`åˆå§‹åŒ–å¤±æ•—: ${err.message}`, 'error');
                
                // å¸¸è¦‹éŒ¯èª¤æç¤º
                if (err.message.includes('400')) {
                    addLog('ğŸ’¡ å¯èƒ½åŸå› ï¼šLIFF ID éŒ¯èª¤æˆ–å·²è¢«åˆªé™¤', 'error');
                } else if (err.message.includes('403')) {
                    addLog('ğŸ’¡ å¯èƒ½åŸå› ï¼šEndpoint URL è¨­å®šéŒ¯èª¤', 'error');
                } else if (err.message.includes('network')) {
                    addLog('ğŸ’¡ å¯èƒ½åŸå› ï¼šç¶²è·¯é€£ç·šå•é¡Œ', 'error');
                }
            });
        }

        // ========== ç™»å…¥è™•ç† ==========
        function liffLogin() {
            addLog('ğŸ” åŸ·è¡Œ LIFF ç™»å…¥...');
            liff.login({ redirectUri: window.location.href });
        }

        // ========== ç²å–ç”¨æˆ¶è³‡æ–™ ==========
        function getUserProfile() {
            addLog('ğŸ“‹ é–‹å§‹ç²å–ç”¨æˆ¶è³‡æ–™...');
            updateStatus('æ­£åœ¨ç²å–ç”¨æˆ¶è³‡æ–™...', 'loading');
            
            liff.getProfile()
            .then(profile => {
                currentUserId = profile.userId;
                
                addLog(`âœ… æˆåŠŸç²å–ç”¨æˆ¶è³‡æ–™`, 'success');
                addLog(`- åç¨±: ${profile.displayName}`);
                addLog(`- User ID: ${currentUserId}`);
                addLog(`- ç‹€æ…‹è¨Šæ¯: ${profile.statusMessage || '(ç„¡)'}`);
                addLog(`- é ­åƒ URL: ${profile.pictureUrl ? 'æœ‰' : 'ç„¡'}`);
                
                document.getElementById('user-name').textContent = profile.displayName;
                document.getElementById('user-id-display').textContent = currentUserId;
                
                // é¡¯ç¤ºä»»å‹™å€å¡Š
                document.getElementById('task-area').style.display = 'block';
                addLog('âœ… é¡¯ç¤ºä»»å‹™å€å¡Š', 'success');
                
                updateStatus('ç™»å…¥æˆåŠŸï¼', 'success');
                addLog('---');
                
                // ç²å–é»æ•¸
                fetchPoints(currentUserId);
            })
            .catch((err) => {
                addLog(`âŒ ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—`, 'error');
                addLog(`éŒ¯èª¤: ${err.message}`, 'error');
                updateStatus(`ç„¡æ³•ç²å–å€‹äººè³‡æ–™: ${err.message}`, 'error');
            });
        }
        
        // ========== æŸ¥è©¢é»æ•¸ ==========
        function fetchPoints(userId) {
            addLog('ğŸ’° é–‹å§‹æŸ¥è©¢é»æ•¸...');
            
            const url = `${APPS_SCRIPT_URL}?userId=${userId}&action=getPoints`;
            addLog(`è«‹æ±‚ URL: ${url.substring(0, 100)}...`);
            
            fetch(url)
            .then(response => {
                addLog(`ä¼ºæœå™¨å›æ‡‰ç‹€æ…‹: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                addLog(`ä¼ºæœå™¨å›æ‡‰: ${JSON.stringify(data)}`);
                
                if (data.status === 'success') {
                    document.getElementById('current-points').textContent = `${data.points} é»`;
                    addLog(`âœ… ç•¶å‰é»æ•¸: ${data.points}`, 'success');
                    
                    if (data.lastSignIn) {
                        document.getElementById('task-message').textContent = 
                            `ä¸Šæ¬¡ç°½åˆ°: ${data.lastSignIn}`;
                        addLog(`ä¸Šæ¬¡ç°½åˆ°: ${data.lastSignIn}`);
                    }
                } else {
                    addLog(`âŒ æŸ¥è©¢é»æ•¸å¤±æ•—: ${data.message}`, 'error');
                }
            })
            .catch(err => {
                addLog(`âŒ é€£ç·šå¤±æ•—: ${err.message}`, 'error');
                addLog('è«‹æª¢æŸ¥ Apps Script URL æ˜¯å¦æ­£ç¢º', 'error');
            });
        }

        // ========== ç°½åˆ°ä»»å‹™ ==========
        function signInTask() {
            if (!currentUserId) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }

            addLog('âœï¸ åŸ·è¡Œç°½åˆ°ä»»å‹™...');
            const btn = document.getElementById('sign-in-btn');
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            fetch(`${APPS_SCRIPT_URL}?userId=${currentUserId}&action=signIn`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                addLog(`ç°½åˆ°å›æ‡‰: ${JSON.stringify(data)}`);
                
                btn.disabled = false;
                btn.textContent = 'ğŸ“ é»æ“Šç°½åˆ° (+10é»)';
                
                if (data.status === 'success') {
                    document.getElementById('current-points').textContent = `${data.newPoints} é»`;
                    document.getElementById('task-message').textContent = data.message;
                    addLog(`âœ… ${data.message}`, 'success');
                    alert(`ğŸ‰ ${data.message}\nç•¶å‰é»æ•¸: ${data.newPoints}`);
                } else {
                    document.getElementById('task-message').textContent = data.message;
                    addLog(`âŒ ${data.message}`, 'error');
                    alert(data.message);
                }
            })
            .catch(err => {
                addLog(`âŒ ç°½åˆ°å¤±æ•—: ${err.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸ“ é»æ“Šç°½åˆ° (+10é»)';
                alert('ç°½åˆ°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
        }

        // ========== æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ==========
        initializeLiff();
    </script>
</body>
</html>
