<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF ä»»å‹™ç³»çµ±</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f5f5f5; text-align: center; }
        
        /* å€‹äººè³‡æ–™å€ */
        #profile { display: none; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        img { border-radius: 50%; width: 80px; height: 80px; margin-bottom: 10px; border: 3px solid #06C755; }
        
        /* é»æ•¸é¡¯ç¤º */
        .points-box { font-size: 24px; color: #06C755; font-weight: bold; margin: 10px 0; }
        .sub-text { font-size: 12px; color: #999; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; margin-top: 10px; cursor: pointer; color: white; transition: 0.2s; }
        .btn-login { background-color: #06C755; display: none; } /* é è¨­éš±è— */
        .btn-sign { background-color: #00B900; }
        .btn-redeem { background-color: #FF5722; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* è¼‰å…¥ä¸­é®ç½© */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column;}
        
        /* ä»»å‹™å€å¡Š (é è¨­éš±è—) */
        #task-area { display: none; }
    </style>
</head>
<body>

    <div id="loading">
        <p>ğŸš€ ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>

    <h2>LIFF ä»»å‹™ç³»çµ±</h2>

    <button id="btnLogin" class="btn-login">ç™»å…¥ LINE å¸³è™Ÿ</button>

    <div id="profile">
        <img id="pictureUrl" src="" alt="User">
        <h3 id="displayName"></h3>
        <div class="points-box"><span id="points-val">--</span> é»</div>
        <div class="sub-text" id="last-sign">ä¸Šæ¬¡ç°½åˆ°: --</div>
    </div>

    <div id="task-area">
        <button id="btn-sign" class="btn-sign" onclick="doAction('signIn')">ğŸ“ æ¯æ—¥ç°½åˆ° (+10é»)</button>
        <button id="btn-redeem" class="btn-redeem" onclick="doAction('redeem')">ğŸ å…Œæ›åºè™Ÿ (æ‰£50é»)</button>
    </div>

    <script>
        // ==========================================
        const myLiffId = "2008638301-NeqDPLxQ";
        // ä½ çš„ GAS å¾Œç«¯ç¶²å€
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSCWxqEMxkGRC-me5BIO-94u4IPpGWzPWp6OoBuZBpT3mOEu3GDz4vzQdX29BylXgq_Q/exec';
        // ==========================================

        let myUserId = '';

        // 1. åˆå§‹åŒ– LIFF
        function initializeLiff(liffId) {
            liff.init({ liffId: liffId })
                .then(() => {
                    initializeApp();
                })
                .catch((err) => {
                    alert('åˆå§‹åŒ–å¤±æ•—: ' + err);
                    document.getElementById('loading').style.display = 'none';
                });
        }

        function initializeApp() {
            document.getElementById('loading').style.display = 'none';

            if (liff.isLoggedIn()) {
                getProfile();
            } else {
                document.getElementById('btnLogin').style.display = 'inline-block';
            }
        }

        // ç¶å®šç™»å…¥æŒ‰éˆ•
        document.getElementById('btnLogin').onclick = function() {
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        };

        // 2. å–å¾—è³‡æ–™ä¸¦å‘¼å«å¾Œç«¯
        function getProfile() {
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').innerHTML = '<p>æ­£åœ¨è®€å–è³‡æ–™...</p>';

            liff.getProfile().then(profile => {
                myUserId = profile.userId;
                document.getElementById('displayName').innerText = profile.displayName;
                if (profile.pictureUrl) {
                    document.getElementById('pictureUrl').src = profile.pictureUrl;
                }
                
                // é¡¯ç¤ºä»‹é¢
                document.getElementById('profile').style.display = 'block';
                document.getElementById('task-area').style.display = 'block';
                document.getElementById('btnLogin').style.display = 'none';
                document.getElementById('loading').style.display = 'none';

                // ğŸ”¥ é—œéµä¸€æ­¥ï¼šç«‹åˆ»å»å• GAS é»æ•¸å¤šå°‘
                doAction('getPoints');

            }).catch(err => {
                console.error('å–å¾—è³‡æ–™å¤±æ•—', err);
                alert('å–å¾—è³‡æ–™å¤±æ•—: ' + err);
                document.getElementById('loading').style.display = 'none';
            });
        }

        // 3. å‘¼å« GAS å¾Œç«¯ (ç°½åˆ°ã€æŸ¥è©¢ã€å…Œæ›)
        function doAction(actionName) {
            if (!myUserId) return;
            
            // è®“æŒ‰éˆ•è®Šç°ï¼Œé¿å…é€£é»
            setBtnLoading(true);

            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `userId=${myUserId}&action=${actionName}`
            })
            .then(res => res.json())
            .then(data => {
                setBtnLoading(false);
                
                if (data.status === 'success') {
                    // æ›´æ–°ä»‹é¢æ•¸å­—
                    if (data.points !== undefined) updatePointsUI(data.points);
                    if (data.newPoints !== undefined) updatePointsUI(data.newPoints);
                    if (data.lastSignIn) document.getElementById('last-sign').innerText = 'ä¸Šæ¬¡ç°½åˆ°: ' + data.lastSignIn;

                    // å½ˆå‡ºè¨Šæ¯
                    if (actionName === 'signIn') alert(data.message);
                    if (actionName === 'redeem') alert(`ğŸ‰ å…Œæ›æˆåŠŸï¼åºè™Ÿï¼š${data.couponCode}`);

                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(err => {
                setBtnLoading(false);
                alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS');
            });
        }

        function updatePointsUI(pts) {
            document.getElementById('points-val').innerText = pts;
            const btnRedeem = document.getElementById('btn-redeem');
            
            if (pts < 50) {
                btnRedeem.classList.add('btn-disabled');
                btnRedeem.innerText = `ğŸ é»æ•¸ä¸è¶³ (${pts}/50)`;
            } else {
                btnRedeem.classList.remove('btn-disabled');
                btnRedeem.innerText = `ğŸ å…Œæ›åºè™Ÿ (æ‰£50é»)`;
            }
        }

        function setBtnLoading(isLoading) {
            const btns = document.querySelectorAll('#task-area button');
            btns.forEach(b => b.disabled = isLoading);
        }

        // å•Ÿå‹•ï¼
        initializeLiff(myLiffId);
    </script>
</body>
</html>
