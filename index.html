<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF æ ¸å½ˆæ¸¬è©¦ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/sdk/2/liff.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #d32f2f; }
        .info-box { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba; }
        .points { font-size: 36px; color: #d35400; font-weight: bold; text-align: center; margin: 15px 0; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; margin-top: 10px; cursor: pointer; color: white; transition: 0.2s; }
        .btn-sign { background-color: #00B900; }
        .btn-redeem { background-color: #FF5722; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; }
        
        .log { font-size: 11px; color: #999; margin-top: 25px; border-top: 1px solid #eee; padding-top: 10px; font-family: monospace; max-height: 200px; overflow-y: auto;}
    </style>
</head>
<body>
    <div class="container">
        <h2>â˜¢ï¸ å¼·åˆ¶ç•¥éæ¨¡å¼</h2>
        
        <div id="loading" style="text-align: center; padding: 20px;">
            <p>æ­£åœ¨å˜—è©¦é€£ç·š...</p>
            <p style="font-size:12px; color:#999;">(è¶…é3ç§’å°‡è‡ªå‹•åˆ‡æ›)</p>
        </div>

        <div id="main-area" style="display:none;">
            <div class="info-box">
                <div style="font-weight:bold; color:#856404;">âš ï¸ ç›®å‰ç‹€æ…‹ï¼š<span id="connection-status">æ­£å¸¸</span></div>
                <hr style="border:0; border-top:1px solid #ffeeba; margin:10px 0;">
                <div>ç”¨æˆ¶ï¼š<span id="user-name">--</span></div>
                <div style="font-size:10px; color:#999;" id="user-id">--</div>
                <div class="points"><span id="points-val">--</span> é»</div>
                <div style="text-align:center; font-size:12px; color:#666;" id="last-sign">ä¸Šæ¬¡ç°½åˆ°: --</div>
            </div>

            <button id="btn-sign" class="btn-sign" onclick="doAction('signIn')">ğŸ“ æ¯æ—¥ç°½åˆ° (+10é»)</button>
            <button id="btn-redeem" class="btn-redeem" onclick="doAction('redeem')">ğŸ å…Œæ›åºè™Ÿ (æ‰£50é»)</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        const MY_LIFF_ID = '2008638301-NeqDPLxQ'; 
        // ä½ çš„ GAS ç¶²å€
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSCWxqEMxkGRC-me5BIO-94u4IPpGWzPWp6OoBuZBpT3mOEu3GDz4vzQdX29BylXgq_Q/exec'; 

        let myUserId = '';
        let isMockMode = false;

        function log(msg) {
            const el = document.getElementById('log');
            const t = new Date().toLocaleTimeString('zh-TW', {hour12:false});
            el.innerHTML = `[${t}] ${msg}<br>` + el.innerHTML;
        }

        window.onload = function() {
            log('é é¢è¼‰å…¥ï¼Œé–‹å§‹è¨ˆæ™‚...');
            
            // ğŸ”¥ æ ¸å¿ƒé‚è¼¯ï¼šè¨­å®š 3 ç§’è¶…æ™‚
            // å¦‚æœ 3 ç§’å¾Œè¿˜æ²¡åˆå§‹åŒ–æˆåŠŸï¼Œç›´æ¥å¼·åˆ¶é€²å…¥
            const timer = setTimeout(() => {
                if (!myUserId) {
                    log('â³ é€£ç·šé€¾æ™‚ï¼å•Ÿå‹•å¼·åˆ¶æ¨¡å¼');
                    startMockMode();
                }
            }, 3000);

            // å˜—è©¦æ­£å¸¸é€£ç·š
            try {
                if (!window.liff) throw new Error('SDK æœªè¼‰å…¥');
                
                liff.init({ liffId: MY_LIFF_ID })
                    .then(() => {
                        clearTimeout(timer); // æˆåŠŸäº†å°±å–æ¶ˆè¨ˆæ™‚
                        log('âœ… LIFF é€£ç·šæˆåŠŸ');
                        if (!liff.isLoggedIn()) {
                            liff.login();
                        } else {
                            return liff.getProfile();
                        }
                    })
                    .then(profile => {
                        if (profile) initUser(profile.userId, profile.displayName, 'LINE æ­£å¼é€£ç·š');
                    })
                    .catch(err => {
                        log('âŒ LIFF éŒ¯èª¤: ' + err.message);
                        // å¤±æ•—ä¹Ÿæ²’é—œä¿‚ï¼Œè¨ˆæ™‚å™¨æœƒæ•‘æˆ‘å€‘
                    });
            } catch (e) {
                log('âŒ SDK åš´é‡éŒ¯èª¤ï¼Œç­‰å¾…å€’æ•¸...');
            }
        };

        function startMockMode() {
            isMockMode = true;
            const randomId = 'TEST_' + Math.floor(Math.random() * 10000);
            initUser(randomId, 'æ¸¬è©¦äººå“¡(å¼·åˆ¶)', 'âš ï¸ å½é€ é€£ç·šæ¨¡å¼');
        }

        function initUser(id, name, statusText) {
            myUserId = id;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-area').style.display = 'block';
            
            document.getElementById('user-name').innerText = name;
            document.getElementById('user-id').innerText = id;
            document.getElementById('connection-status').innerText = statusText;
            
            if (isMockMode) {
                document.getElementById('connection-status').style.color = 'red';
            } else {
                document.getElementById('connection-status').style.color = 'green';
            }

            // é›–ç„¶æ˜¯å‡èº«åˆ†ï¼Œä½†å¾Œç«¯ GAS æ˜¯çœŸçš„ï¼Œæ‰€ä»¥é€™è£¡æœƒçœŸçš„å»æ‰“ API
            doAction('getPoints');
        }

        function doAction(actionName) {
            log(`å‘¼å«å¾Œç«¯: ${actionName}...`);
            setLoading(true);

            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `userId=${myUserId}&action=${actionName}`
            })
            .then(res => res.json())
            .then(data => {
                setLoading(false);
                log(`å›æ‡‰: ${JSON.stringify(data)}`);
                
                if (data.status === 'success') {
                    if (data.points !== undefined) document.getElementById('points-val').innerText = data.points;
                    if (data.newPoints !== undefined) document.getElementById('points-val').innerText = data.newPoints;
                    if (data.lastSignIn) document.getElementById('last-sign').innerText = 'ä¸Šæ¬¡ç°½åˆ°: ' + data.lastSignIn;
                    
                    if (actionName === 'redeem') {
                        alert(`ğŸ‰ å…Œæ›æˆåŠŸï¼\nåºè™Ÿï¼š${data.couponCode}`);
                    } else {
                        // ç°½åˆ°æˆåŠŸ
                        // alert(data.message); 
                    }
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(err => {
                setLoading(false);
                log('é€£ç·šå¤±æ•—: ' + err.message);
                alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS');
            });
        }

        function setLoading(isLoading) {
            const btns = document.querySelectorAll('button');
            btns.forEach(b => b.disabled = isLoading);
        }
    </script>
</body>
</html>
